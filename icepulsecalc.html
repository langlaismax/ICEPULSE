<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IcePulse — Split Time Calculator (Standalone)</title>
  <style>
    :root{ --bg:#fff; --text:#111; --muted:#666; --blue:#0a66ff; --card:#fafafa }
    html,body{height:100%;margin:0;padding:18px;font-family:Inter,system-ui,Arial;background:var(--bg);color:var(--text)}
    h1{margin:0 0 8px 0;font-size:20px}
    .card{border:1px solid #eee;border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,0.04);max-width:1100px;background:var(--card)}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-top:12px}
    #display{font-size:48px;font-weight:800;margin-bottom:8px}
    button{cursor:pointer;border:0;padding:10px 14px;border-radius:8px}
    .primary{background:var(--blue);color:white}
    .alt{background:#fff;border:1px solid #ddd}
    input,select{padding:8px 10px;border-radius:8px;border:1px solid #ddd;font-size:16px}
    .small{font-size:13px;color:var(--muted)}
    #result{font-size:22px;margin-top:10px;font-weight:700}
    #log{max-height:240px;overflow:auto;margin-top:12px;border-top:1px dashed #eee;padding-top:8px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:6px 4px;text-align:left;border-bottom:1px solid #f4f4f4;font-size:13px}
    .grid {display:grid; grid-template-columns: 1fr 420px; gap:12px; align-items:start;}
    @media (max-width:980px){ .grid{ grid-template-columns: 1fr } }
    .chart-wrap{height:260px;padding:8px;border:1px solid #eee;border-radius:8px;background:white}

    /* column buttons */
    .col-buttons{display:flex;flex-wrap:wrap;gap:8px}
    .col-btn{min-width:44px;padding:8px 10px;border-radius:8px;border:1px solid #ddd;background:#fff}
    .col-btn.selected{background:var(--blue);color:#fff;border-color:rgba(0,0,0,0.06);box-shadow:0 6px 12px rgba(10,102,255,0.12)}
    .col-btn:disabled{opacity:0.45;cursor:not-allowed}
  </style>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <h1>IcePulse — Split Time Calculator (Standalone)</h1>
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;">
      <div>
        <div id="display">0.00</div>
        <div class="small">Elapsed (seconds)</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button id="startStop" class="primary">Start</button>
        <button id="resetBtn" class="alt">Reset</button>
        <button id="grabBtn" class="alt">Use Display</button>
      </div>
    </div>

    <div class="row" style="margin-top:18px">
      <label for="entered" class="small">Entered split (s)</label>
      <input id="entered" type="number" step="0.01" placeholder="e.g. 13.25" />

      <div style="display:flex;flex-direction:column;">
        <div class="small">Final location (pick one)</div>
        <div id="colButtons" class="col-buttons" aria-label="Final location buttons"></div>
      </div>

      <button id="calcBtn" class="primary" disabled>Calculate real split</button>
      <button id="addLog" class="alt" disabled>Add to log</button>
      <button id="downloadCsv" class="alt">Download CSV</button>
    </div>

    <div id="result" aria-live="polite">Real split: —</div>

    <div class="grid" style="margin-top:12px">
      <div>
        <div id="log">
          <table id="logTable">
            <thead><tr><th>Timestamp</th><th>Column</th><th>Entered (s)</th><th>Real (s)</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div>
        <div class="small" style="margin-bottom:8px">Live view (last 10 splits)</div>
        <div class="chart-wrap">
          <canvas id="splitsChart" width="400" height="240" aria-label="Last ten splits chart" role="img"></canvas>
        </div>
      </div>
    </div>

    <div class="small" style="margin-top:10px">
      Algorithm & conversion table taken from the Raspberry Pi server source (`icepulse0.98.py`) — lookup finds the table row with the closest value in the selected column and returns the 7th column value from that row (same as original).
    </div>
  </div>

<script>
/* === conversion data (copied from your Python file) === */
const columns = [ "1","2","3","4","5","6","7","8","9","10","H" ];

const conversion_table = [
  [16.2,15.1,14.3,13.9,13.6,13.4,13.0,12.7,12.6,12.5,11.9],
  [16.3,15.2,14.4,14.0,13.7,13.5,13.1,12.8,12.7,12.6,11.9],
  [16.4,15.3,14.5,14.2,13.8,13.6,13.2,12.9,12.8,12.7,12.0],
  [16.5,15.4,14.6,14.3,14.0,13.7,13.3,13.0,12.9,12.8,12.1],
  [16.7,15.5,14.7,14.4,14.1,13.8,13.4,13.1,13.0,12.9,12.2],
  [16.8,15.6,14.8,14.5,14.2,13.9,13.5,13.2,13.1,12.9,12.3],
  [16.9,15.8,14.9,14.6,14.3,14.0,13.6,13.3,13.2,13.0,12.4],
  [17.0,15.9,15.0,14.7,14.4,14.1,13.7,13.4,13.2,13.1,12.5],
  [17.2,16.0,15.1,14.8,14.5,14.2,13.8,13.5,13.3,13.2,12.6],
  [17.3,16.1,15.3,14.9,14.6,14.3,13.9,13.5,13.4,13.3,12.7],
  [17.4,16.2,15.4,15.0,14.7,14.4,14.0,13.6,13.5,13.4,12.8],
  [17.5,16.3,15.5,15.1,14.8,14.5,14.1,13.7,13.6,13.5,12.9],
  [17.7,16.5,15.7,15.2,14.9,14.6,14.2,13.8,13.7,13.6,13.0],
  [17.8,16.6,15.8,15.4,15.0,14.7,14.3,13.9,13.8,13.7,13.1],
  [17.9,16.7,16.0,15.5,15.1,14.8,14.4,14.0,13.9,13.8,13.2],
  [18.1,16.9,16.1,15.6,15.2,14.9,14.5,14.1,14.0,13.9,13.2],
  [18.2,17.0,16.2,15.8,15.3,15.0,14.6,14.2,14.1,14.0,13.3],
  [18.3,17.1,16.4,15.9,15.5,15.1,14.7,14.3,14.2,14.1,13.4],
  [18.4,17.2,16.5,16.0,15.6,15.2,14.8,14.4,14.3,14.2,13.5],
  [18.5,17.3,16.6,16.1,15.7,15.3,14.9,14.5,14.4,14.3,13.5],
  [18.7,17.5,16.7,16.2,15.8,15.4,15.0,14.5,14.5,14.4,13.6],
  [18.8,17.6,16.8,16.4,15.9,15.6,15.1,14.7,14.6,14.5,13.7],
  [18.9,17.7,16.9,16.5,16.0,15.6,15.2,14.8,14.7,14.6,13.8],
  [19.0,17.8,17.0,16.6,16.1,15.7,15.3,14.9,14.8,14.7,13.9],
  [19.2,17.9,17.1,16.7,16.2,15.8,15.4,15.0,14.9,14.8,14.0],
  [19.3,18.1,17.2,16.8,16.3,15.9,15.5,15.1,15.0,14.9,14.1],
  [19.4,18.2,17.3,16.9,16.5,16.2,15.8,15.4,15.3,15.2,14.5],
  [19.5,18.3,17.4,16.9,16.6,16.3,15.9,15.5,15.4,15.3,14.6],
  [19.6,18.4,17.5,17.0,16.7,16.4,16.0,15.6,15.5,15.4,14.6],
  [19.7,18.5,17.6,17.2,16.8,16.5,16.0,15.6,15.5,15.3,14.6],
  [19.9,18.7,17.7,17.3,16.9,16.6,16.1,15.7,15.6,15.4,14.7],
  [20.0,18.8,17.8,17.4,17.0,16.7,16.2,15.8,15.7,15.5,14.8],
  [20.2,18.9,17.9,17.5,17.1,16.8,16.3,15.9,15.8,15.6,14.9],
  [20.3,19.0,18.0,17.6,17.2,16.9,16.4,16.0,15.9,15.7,15.0],
  [20.5,19.1,18.1,17.7,17.3,17.0,16.5,16.1,16.0,15.8,15.0],
  [20.6,19.2,18.2,17.8,17.4,17.1,16.6,16.2,16.1,15.9,15.1],
  [20.8,19.3,18.3,17.9,17.5,17.2,16.7,16.3,16.1,16.0,15.2]
];

/* === stopwatch logic === */
let running=false, startTs=0, elapsed=0;
const displayEl = document.getElementById('display');
const startStopBtn = document.getElementById('startStop');

let selectedColumn = null; // user must pick one of the column buttons before calculating/logging

function updateDisplay(){
  let value = elapsed;
  if (running) value = (Date.now()/1000 - startTs) + elapsed;
  displayEl.innerText = value.toFixed(2);
}
setInterval(updateDisplay, 100);

/* create column buttons (11 buttons) */
const colButtonsWrap = document.getElementById('colButtons');
function renderColumnButtons(){
  columns.forEach(c => {
    const b = document.createElement('button');
    b.type = 'button';
    b.className = 'col-btn';
    b.innerText = c;
    b.dataset.col = c;
    b.addEventListener('click', ()=>{
      // set selection
      selectedColumn = c;
      // update UI: remove selected from others
      document.querySelectorAll('.col-btn').forEach(x=>x.classList.remove('selected'));
      b.classList.add('selected');
      // enable calculate/add buttons
      document.getElementById('calcBtn').disabled = false;
      document.getElementById('addLog').disabled = false;
    });
    colButtonsWrap.appendChild(b);
  });
}
renderColumnButtons();

/* lookup function: same algorithm as Python's lookup_real_split */
function lookupRealSplit(column, enteredValue){
  const colIndex = columns.indexOf(String(column));
  if (colIndex === -1) return null;
  let closestRow = null;
  let closestDiff = Number.POSITIVE_INFINITY;
  for (const row of conversion_table){
    const val = row[colIndex];
    const diff = Math.abs(val - enteredValue);
    if (diff < closestDiff){
      closestDiff = diff;
      closestRow = row;
    }
  }
  // return the 7th value (index 6) from the closest row, just like the Python function.
  return closestRow ? closestRow[6] : null;
}

/* client-side log, chart state, and CSV download */
let splitLog = []; // {ts, col, entered, real}
const MAX_LOG = 10;

function addLogEntry(ts, col, ent, real){
  splitLog.push({ts, col, entered: Number(ent), real: real === null ? null : Number(real)});
  if (splitLog.length > MAX_LOG) splitLog.shift();
  renderLogTable();
  updateChart();
}

function renderLogTable(){
  const tbody = document.querySelector('#logTable tbody');
  tbody.innerHTML = '';
  for (let i = splitLog.length - 1; i >= 0; i--){
    const row = splitLog[i];
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${row.ts}</td><td>${row.col}</td><td>${row.entered.toFixed(2)}</td><td>${row.real !== null ? row.real.toFixed(2) : 'N/A'}</td>`;
    tbody.appendChild(tr);
  }
}

/* Chart setup */
const ctx = document.getElementById('splitsChart').getContext('2d');
const splitsChart = new Chart(ctx, {
  type: 'line',
  data: {
    labels: [], // timestamps
    datasets: [
      {
        label: 'Entered (s)',
        data: [],
        tension: 0.3,
        pointRadius: 4,
        borderColor: 'rgba(10,102,255,0.85)',
        backgroundColor: 'rgba(10,102,255,0.08)',
        yAxisID: 'y'
      },
      {
        label: 'Real (s)',
        data: [],
        tension: 0.3,
        pointRadius: 4,
        borderColor: 'rgba(0,170,90,0.85)',
        backgroundColor: 'rgba(0,170,90,0.08)',
        yAxisID: 'y'
      }
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    interaction: { mode: 'index', intersect: false },
    plugins: {
      legend: { display: true, position: 'top' },
      tooltip: { mode: 'index', intersect: false }
    },
    scales: {
      x: { display: true },
      y: {
        display: true,
        title: { display: true, text: 'Seconds' },
        beginAtZero: false
      }
    }
  }
});

function updateChart(){
  const labels = splitLog.map(r => {
    const d = new Date(r.ts);
    return d.toLocaleTimeString();
  });
  const enteredData = splitLog.map(r => r.entered);
  const realData = splitLog.map(r => r.real === null ? NaN : r.real);
  splitsChart.data.labels = labels;
  splitsChart.data.datasets[0].data = enteredData;
  splitsChart.data.datasets[1].data = realData;
  splitsChart.update();
}

/* === UI control handlers === */
startStopBtn.addEventListener('click', ()=>{
  if(!running){
    // start
    running=true;
    startTs = Date.now()/1000;
    startStopBtn.innerText='Stop';
  } else {
    // stop -> capture elapsed
    running=false;
    elapsed = (Date.now()/1000 - startTs) + elapsed;
    startStopBtn.innerText='Start';
    updateDisplay();

    // AUTO-LOG: ensure user selected final location first
    if (!selectedColumn){
      alert('Please select the final location of the rock (pick one of the buttons) before logging or calculating the real split.');
      return; // do not compute or log until a column is selected
    }

    const ent = Number(displayEl.innerText || 0);
    if (!isNaN(ent) && ent > 0) {
      // populate entered field
      document.getElementById('entered').value = ent.toFixed(2);
      const col = selectedColumn;
      const real = lookupRealSplit(col, ent);
      // show computed result
      if (real === null || real === undefined) {
        document.getElementById('result').innerText = 'Real split: N/A';
      } else {
        document.getElementById('result').innerText = 'Real split: ' + real.toFixed(2) + ' s';
      }
      // add to log
      const ts = new Date().toISOString();
      addLogEntry(ts, col, ent, real !== null ? real : null);
    }
  }
});

document.getElementById('resetBtn').addEventListener('click', ()=>{
  running=false; startTs=0; elapsed=0; displayEl.innerText='0.00'; startStopBtn.innerText='Start';
});
document.getElementById('grabBtn').addEventListener('click', ()=>{
  document.getElementById('entered').value = parseFloat(displayEl.innerText || 0).toFixed(2);
});

/* manual calculate button */
document.getElementById('calcBtn').addEventListener('click', ()=>{
  if (!selectedColumn){ alert('Select final location first'); return; }
  const ent = parseFloat(document.getElementById('entered').value);
  if (isNaN(ent)){ alert('Enter a split (seconds)'); return; }
  const col = selectedColumn;
  const real = lookupRealSplit(col, ent);
  if (real === null || real === undefined){
    document.getElementById('result').innerText = 'Real split: N/A';
  } else {
    document.getElementById('result').innerText = 'Real split: ' + real.toFixed(2) + ' s';
  }
});

/* Add-to-log button handler (manual) */
document.getElementById('addLog').addEventListener('click', ()=>{
  if (!selectedColumn){ alert('Select final location first'); return; }
  const ent = parseFloat(document.getElementById('entered').value);
  if (isNaN(ent)){ alert('Enter a split first'); return; }
  const col = selectedColumn;
  const real = lookupRealSplit(col, ent);
  const ts = new Date().toISOString();
  addLogEntry(ts, col, ent, real !== null ? real : null);
});

/* CSV download uses splitLog */
document.getElementById('downloadCsv').addEventListener('click', ()=>{
  if (splitLog.length === 0){ alert('No logged rows to download'); return; }
  const rows = [];
  rows.push(['Timestamp','Column','EnteredSplit','RealSplit']);
  for (let i = splitLog.length - 1; i >= 0; i--){
    const r = splitLog[i];
    rows.push([r.ts, r.col, r.entered.toFixed(2), r.real !== null ? r.real.toFixed(2) : 'N/A']);
  }
  const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'splits_log.csv'; document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 500);
});

/* initialize (chart/table empty) */
</script>
</body>
</html>
